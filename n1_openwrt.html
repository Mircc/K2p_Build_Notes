<!DOCTYPE html> <html lang="zh"> <head> <meta charset="utf-8"/> <title>Markdown在线编辑器 - www.MdEditor.com</title> <link rel="shortcut icon" href="https://www.mdeditor.com/images/logos/favicon.ico" type="image/x-icon"/> </head> <body><h1 id="h1-u524Du8A00"><a name="前言" class="reference-link"></a><span class="header-link octicon octicon-link"></span>前言</h1><p>在hub.docker.com上已经有很多n1可用的openwrt镜像了，但是其功能可能并不是那么符合自己的需要，这里可以自己制作一个docker的openwrt镜像。</p> <h1 id="h1-u8FC7u7A0B"><a name="过程" class="reference-link"></a><span class="header-link octicon octicon-link"></span>过程</h1><h2 id="h2--docker"><a name="安装docker" class="reference-link"></a><span class="header-link octicon octicon-link"></span>安装docker</h2><p>生成docker镜像必不可少的就是安装好docker</p> <p><code>curl -fsSL https://get.docker.com | sudo bash</code></p> <h2 id="h2--openwrt"><a name="编译openwrt" class="reference-link"></a><span class="header-link octicon octicon-link"></span>编译openwrt</h2><p>首先是从源码编译出一个openwrt镜像。<br>这里可以参考：<a href="https://zorz.cc/post/k2p-compile-openwrt.html" title="编译k2p的openwrt固件">编译k2p的openwrt固件</a><br>但是目标设备选择不同。<br>这里的选择是 </p><p><code>Target选 "QEMU ARM Virtual Machine" &gt; "ARMv8 multiplatform" Target Images 要选上tar.gz</code></p> <h2 id="h2-u4E00u952Eu811Au672C"><a name="一键脚本" class="reference-link"></a><span class="header-link octicon octicon-link"></span>一键脚本</h2><p>这里感谢恩山的<a href="https://github.com/flippy" title="@flippy" class="at-link">@flippy</a>，他制作了一键脚本方便生成docker镜像：<a href="https://zorz.cc/wp-content/uploads/2019/11/make_opwrt_docker_img.tar.gz" title="make_opwrt_docker_img.tar.gz">make_opwrt_docker_img.tar.gz</a><br>下载好脚本之后<br>解压脚本，可以将脚本放置到你喜欢的目录，将之前生成的tar.gz文件放到脚本同一目录。<br>创建存放生成的镜像打包文件的目录 </p><p><code>sudo mkdir -p /opt/imgs/docker</code><br>开始生成镜像，在脚本存在目录执行 </p><p><code>sudo bash build.sh tag</code>tag就是docker镜像的版本号，例如r9.10.24，tag可以为空，则其为默认值：latest<br>脚本用到了pigz如果没有这个工具，需要安装 </p><p><code>apt-get install pigz</code><br>可以在/opt/imgs/docker目录查看生成好的镜像文件 </p><h2 id="h2-u5BFCu5165u955Cu50CF"><a name="导入镜像" class="reference-link"></a><span class="header-link octicon octicon-link"></span>导入镜像</h2><p>将生成好的镜像文件传输到N1，运行以下命令导入<br><code>docker load --input 镜像文件</code><br>导入成功之后，可以参考这篇文章进行使用：N1在armbian的docker中使用openwrt </p><h2 id="h2-u811Au672Cu8BF4u660E"><a name="脚本说明" class="reference-link"></a><span class="header-link octicon octicon-link"></span>脚本说明</h2><pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><code class="lang-bash"><span class="com">#!/bin/bash</span></code></li><li class="L1"><code class="lang-bash"><span class="pln">TAG</span><span class="pun">=</span><span class="pln">latest </span><span class="com"># 版本号，默认是latest</span></code></li><li class="L2"><code class="lang-bash"><span class="kwd">if</span><span class="pln"> </span><span class="pun">[</span><span class="pln"> </span><span class="pun">!</span><span class="pln"> </span><span class="pun">-</span><span class="pln">z </span><span class="str">"$1"</span><span class="pln"> </span><span class="pun">];</span><span class="kwd">then</span></code></li><li class="L3"><code class="lang-bash"><span class="pln"> TAG</span><span class="pun">=</span><span class="pln">$1</span></code></li><li class="L4"><code class="lang-bash"><span class="kwd">fi</span></code></li><li class="L5"><code class="lang-bash"></code></li><li class="L6"><code class="lang-bash"><span class="pln">TMPDIR</span><span class="pun">=</span><span class="pln">openwrt_rootfs</span></code></li><li class="L7"><code class="lang-bash"><span class="pln">OUTDIR</span><span class="pun">=/</span><span class="pln">opt</span><span class="pun">/</span><span class="pln">imgs</span><span class="pun">/</span><span class="pln">docker </span><span class="com"># 本地镜像保存路径，可以自己修改，但目录要提前建好</span></code></li><li class="L8"><code class="lang-bash"><span class="pln">IMG_NAME</span><span class="pun">=</span><span class="pln">unifreq</span><span class="pun">/</span><span class="pln">openwrt</span><span class="pun">-</span><span class="pln">aarch64 </span><span class="com"># 镜像名，可以自己修改</span></code></li><li class="L9"><code class="lang-bash"></code></li><li class="L0"><code class="lang-bash"><span class="pun">[</span><span class="pln"> </span><span class="pun">-</span><span class="pln">d </span><span class="str">"$TMPDIR"</span><span class="pln"> </span><span class="pun">]</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> rm </span><span class="pun">-</span><span class="pln">rf </span><span class="str">"$TMPDIR"</span></code></li><li class="L1"><code class="lang-bash"></code></li><li class="L2"><code class="lang-bash"><span class="pln">mkdir </span><span class="pun">-</span><span class="pln">p </span><span class="str">"$TMPDIR"</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> \</span></code></li><li class="L3"><code class="lang-bash"><span class="pln">gzip </span><span class="pun">-</span><span class="pln">dc openwrt</span><span class="pun">-</span><span class="pln">armvirt</span><span class="pun">-</span><span class="lit">64</span><span class="pun">-</span><span class="pln">default</span><span class="pun">-</span><span class="pln">rootfs</span><span class="pun">.</span><span class="pln">tar</span><span class="pun">.</span><span class="pln">gz </span><span class="pun">|</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> cd </span><span class="str">"$TMPDIR"</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> tar xf </span><span class="pun">-</span><span class="pln"> </span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> \</span></code></li><li class="L4"><code class="lang-bash"><span class="pln">cp </span><span class="pun">-</span><span class="pln">f patches</span><span class="pun">/</span><span class="pln">rc</span><span class="pun">.</span><span class="kwd">local</span><span class="pln"> </span><span class="str">"$TMPDIR/etc/"</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> \</span></code></li><li class="L5"><code class="lang-bash"><span class="pln">cp </span><span class="pun">-</span><span class="pln">f patches</span><span class="pun">/</span><span class="pln">cpustat </span><span class="str">"$TMPDIR/usr/bin/"</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> \</span></code></li><li class="L6"><code class="lang-bash"><span class="pln">chmod </span><span class="lit">755</span><span class="pln"> </span><span class="str">"$TMPDIR/usr/bin/cpustat"</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> \</span></code></li><li class="L7"><code class="lang-bash"><span class="pln">cat patches</span><span class="pun">/</span><span class="pln">luci</span><span class="pun">-</span><span class="pln">admin</span><span class="pun">-</span><span class="pln">status</span><span class="pun">-</span><span class="pln">index</span><span class="pun">-</span><span class="pln">html</span><span class="pun">.</span><span class="pln">patch </span><span class="pun">|</span><span class="pln"> </span><span class="pun">(</span><span class="pln">cd </span><span class="str">"$TMPDIR/usr/lib/lua/luci/view/admin_status/"</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> patch </span><span class="pun">-</span><span class="pln">p0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> \</span></code></li><li class="L8"><code class="lang-bash"><span class="pln">sed </span><span class="pun">-</span><span class="pln">e </span><span class="str">"s/net.nf_conntrack_max net.ipv4.netfilter.ip_conntrack_max/net.netfilter.nf_conntrack_max net.nf_conntrack_max net.ipv4.netfilter.ip_conntrack_max \| head -n 1/"</span><span class="pln"> </span><span class="pun">-</span><span class="pln">i </span><span class="str">"$TMPDIR/usr/lib/lua/luci/view/admin_status/index.htm"</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> \</span></code></li><li class="L9"><code class="lang-bash"><span class="pln">rm </span><span class="pun">-</span><span class="pln">f </span><span class="str">"$TMPDIR/etc/bench.log"</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> \</span></code></li><li class="L0"><code class="lang-bash"><span class="pln">echo </span><span class="str">"17 3 * * * /etc/coremark.sh"</span><span class="pln"> </span><span class="pun">&gt;&gt;</span><span class="pln"> </span><span class="str">"$TMPDIR/etc/crontabs/root"</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> \</span></code></li><li class="L1"><code class="lang-bash"><span class="pun">(</span><span class="pln">cd </span><span class="str">"$TMPDIR"</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> tar cf </span><span class="pun">../</span><span class="pln">openwrt</span><span class="pun">-</span><span class="pln">armvirt</span><span class="pun">-</span><span class="lit">64</span><span class="pun">-</span><span class="pln">default</span><span class="pun">-</span><span class="pln">rootfs</span><span class="pun">-</span><span class="pln">patched</span><span class="pun">.</span><span class="pln">tar </span><span class="pun">.)</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> \</span></code></li><li class="L2"><code class="lang-bash"><span class="pln">rm </span><span class="pun">-</span><span class="pln">f </span><span class="typ">DockerImg</span><span class="pun">-</span><span class="typ">OpenwrtArm64</span><span class="pun">-</span><span class="pln">$</span><span class="pun">{</span><span class="pln">TAG</span><span class="pun">}.</span><span class="pln">gz </span><span class="pun">&amp;&amp;</span><span class="pln"> \</span></code></li><li class="L3"><code class="lang-bash"><span class="pln">docker build </span><span class="pun">-</span><span class="pln">t $</span><span class="pun">{</span><span class="pln">IMG_NAME</span><span class="pun">}:</span><span class="pln">$</span><span class="pun">{</span><span class="pln">TAG</span><span class="pun">}</span><span class="pln"> </span><span class="pun">.</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> \</span></code></li><li class="L4"><code class="lang-bash"><span class="pln">rm </span><span class="pun">-</span><span class="pln">f openwrt</span><span class="pun">-</span><span class="pln">armvirt</span><span class="pun">-</span><span class="lit">64</span><span class="pun">-</span><span class="pln">default</span><span class="pun">-</span><span class="pln">rootfs</span><span class="pun">-</span><span class="pln">patched</span><span class="pun">.</span><span class="pln">tar </span><span class="pun">&amp;&amp;</span><span class="pln"> \</span></code></li><li class="L5"><code class="lang-bash"><span class="pln">rm </span><span class="pun">-</span><span class="pln">rf </span><span class="str">"$TMPDIR"</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> \</span></code></li><li class="L6"><code class="lang-bash"><span class="pln">docker save $</span><span class="pun">{</span><span class="pln">IMG_NAME</span><span class="pun">}:</span><span class="pln">$</span><span class="pun">{</span><span class="pln">TAG</span><span class="pun">}</span><span class="pln"> </span><span class="pun">|</span><span class="pln"> pigz </span><span class="pun">-</span><span class="lit">9</span><span class="pln"> </span><span class="pun">&gt;</span><span class="pln"> $OUTDIR</span><span class="pun">/</span><span class="pln">docker</span><span class="pun">-</span><span class="pln">img</span><span class="pun">-</span><span class="pln">openwrt</span><span class="pun">-</span><span class="pln">aarch64</span><span class="pun">-</span><span class="pln">$</span><span class="pun">{</span><span class="pln">TAG</span><span class="pun">}.</span><span class="pln">gz</span></code></li></ol></pre> <p>参考链接：<br>N1及贝壳云Armbian 5.98(加强版)， 内核5.3.x， 及 Docker Openwrt<br>斐讯N1 / 贝壳云 一键制作OpenWrt镜像脚本 </p></body> </html>
